<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="MBrasebin">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Custom generator - SimPLU3D tutorial</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Custom generator";
    var mkdocs_page_input_path = "generator/custom-generator.md";
    var mkdocs_page_url = "/generator/custom-generator/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> SimPLU3D tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../about/">About</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../bibliographie/">Bibliographie</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../development/">Development</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../export/">Export</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Begin</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../begin/first_simulation/">First simulation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../begin/installation/">Installation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../begin/intro/">Intro</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Envgeo</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../envgeo/integration-test/">Integration test</a>
                </li>
                <li class="">
                    
    <a class="" href="../../envgeo/integration/">Integration</a>
                </li>
                <li class="">
                    
    <a class="" href="../../envgeo/intro/">Intro</a>
                </li>
                <li class="">
                    
    <a class="" href="../../envgeo/modelgeo/">Modelgeo</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Generator</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Custom generator</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#parametrer-les-boites-dune-configuration">Paramétrer les boîtes d'une configuration</a></li>
    

    <li class="toctree-l3"><a href="#definition-des-formes-generables">Définition des formes générables</a></li>
    

    <li class="toctree-l3"><a href="#definition-des-modifications">Définition des modifications</a></li>
    

    <li class="toctree-l3"><a href="#creation-de-lechantillonneur-de-green">Création de l'échantillonneur de Green</a></li>
    

    <li class="toctree-l3"><a href="#implementation">Implémentation</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../custom-optimisation/">Custom optimisation</a>
                </li>
                <li class="">
                    
    <a class="" href="../custom-shape/">Custom shape</a>
                </li>
                <li class="">
                    
    <a class="" href="../intro/">Intro</a>
                </li>
                <li class="">
                    
    <a class="" href="../principe/">Principe</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Openmole</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../openmole/intro/">Intro</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Principe</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../principe/intro/">Intro</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Rules</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../rules/formats/">Formats</a>
                </li>
                <li class="">
                    
    <a class="" href="../../rules/intro/">Intro</a>
                </li>
                <li class="">
                    
    <a class="" href="../../rules/predicate/">Predicate</a>
                </li>
                <li class="">
                    
    <a class="" href="../../rules/topologique/">Topologique</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Visitor</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../visitor/intro/">Intro</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">SimPLU3D tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Generator &raquo;</li>
        
      
    
    <li>Custom generator</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/SimPLU3D/simplu3D-tutorial/generator/custom-generator.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <hr />
<h1 id="parametrer-les-boites-dune-configuration">Paramétrer les boîtes d'une configuration<a class="headerlink" href="#parametrer-les-boites-dune-configuration" title="Permanent link"></a></h1>
<p>Dans cette partie, nous décrivons comment le système définit la création de nouveaux objets paramétriques et les modifications qui leur seront apportées durant l'optimisation. Il s'agit de l'étape 1 du code décrit dans la section <a href="../principe/">principe de simulation</a>. Cet exemple s'appuie sur la génération de boîtes, mais il est possible de définir d'autres types de géométries (cela sera décrit dans la section <a href="../custom-shape/">Générer d'autres types de formes</a>).</p>
<p>Les parties suivantes reprennent les principales étapes de création du sampler dont le code est repris dans <a href="#implementation">la dernière partie de la page sur l'implémentation</a> (étape 1) , c'est à dire le code suivant :</p>
<pre><code class="JAVA">// Step 1 :

// Sampler creation (definition of the class and of the kernel modifications)
// Création de l'échantilloneeur (définition de la classe et des noyaux de modifications)
Sampler&lt;GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; samp = create_sampler(Random.random(), p,
bpu, pred, geom);
</code></pre>

<h1 id="definition-des-formes-generables">Définition des formes générables<a class="headerlink" href="#definition-des-formes-generables" title="Permanent link"></a></h1>
<p>Pour rappel, le processus d'optimisation vise à générer une configuration composée de <em>n</em> boîtes chaque boîte pouvant être définie par un vecteur de dimension 6 :<br />
<strong>b</strong> = (<strong>x</strong>, <strong>y</strong>, <strong>l</strong>, <strong>w</strong>, <strong>h</strong>, <strong>θ</strong>).</p>
<p>Afin de pouvoir échantillonner, il est nécessaire de définir les intervalles dans lesquels le tirage des boîtes sera effectué :</p>
<ul>
<li><strong>xmin</strong> &lt; <strong>x</strong> &lt; <strong>xmax</strong></li>
<li><strong>ymin</strong> &lt; <strong>y</strong> &lt; <strong>ymax</strong></li>
<li><strong>minθ</strong> &lt; <strong>θ</strong> &lt; <strong>maxθ</strong></li>
<li><strong>minwid</strong> &lt; <strong>w</strong> &lt; <strong>maxwid</strong></li>
<li><strong>minlen</strong> &lt; <strong>l</strong> &lt; <strong>maxlen</strong></li>
<li><strong>minheight</strong> &lt; <strong>h</strong> &lt; <strong>maxheight</strong></li>
</ul>
<p>Les deux premières valeurs sont contraintes par l'enveloppe contenant la géométrie dans laquelle les centres de boîtes seront échantillonnés.</p>
<p>Dans l'exemple de la <a href="../../begin/first_simulation/">première simulation</a>, <strong>minθ</strong> et <strong>maxθ</strong> sont fixés  à <strong>0</strong> et <strong>π</strong> afin de permettre tout type d'orientation. Les autres paramètres sont fixés dans le fichier de configuration <strong>params.json</strong>.</p>
<p>Afin que le système puisse générer des formes, il est nécessaire de définir une classe <strong>Builder</strong> qui permet d'instancier les objets à partir d'un tableau contenant les paramètres de la forme. Dans l'exemple, il s'agit de la classe <strong>CuboidBuilder</strong>.</p>
<h1 id="definition-des-modifications">Définition des modifications<a class="headerlink" href="#definition-des-modifications" title="Permanent link"></a></h1>
<p>Une modification aléatoire est est déterminée par le choix d’un des noyaux de proposition. Chaque noyau a la même probabilité d'être sélectionné. Dans le cadre de l'exemple, 6 noyaux sont utilisés :</p>
<ul>
<li>ajout/suppression d’une nouvelle boîte ;</li>
<li>translation d’une boîte ;</li>
<li>changement de la longueur d’une boîte ;</li>
<li>changement de la largeur d’une boîte ;</li>
<li>changement de la hauteur d’une boîte ;</li>
<li>rotation d’une boîte.</li>
</ul>
<p>Exceptés les modifications issues du premier noyau, toutes les modifications sont implémentées comme la suppression et l'ajout d'une boîte. Par exemple, une modification de type changement de longueur d'une boîte <strong>b</strong> = (<strong>x</strong>, <strong>y</strong>, <strong>l</strong>, <strong>w</strong>, <strong>h</strong>, <strong>θ</strong>) est traduite comme la suppression de cette boîte et la création d'une nouvelle boîte avec une longueur différente, définie comme : <strong>b'</strong> = (<strong>x</strong>, <strong>y</strong>, <strong>l</strong> + (<strong>1 - rand</strong>)  x <strong>ampli</strong>, <strong>w</strong>, <strong>h</strong>, <strong>θ</strong>) où <strong>rand</strong> est un nombre aléatoire pris dans [0,1] et <strong>ampli</strong> est un coefficient d'amplification du déplacement (réel strictement positif).
Ainsi, dans la simulation exemple, les coefficients des amplifications (<em>amplitudeMove</em>, <em>amplitudeMaxDim</em>, <em>amplitudeHeight</em>, <em>amplitudeRotate</em>) sont stockés dans le fichier de paramétrage <strong>params.json</strong>.</p>
<p>Les modifications sont implémentées à partir de la classe <strong>Kernel</strong> de la librjmcmc4j qui définit comment modifier un objet de la classe paramétrique utilisée à partir d'un tirage aléatoire.</p>
<h1 id="creation-de-lechantillonneur-de-green">Création de l'échantillonneur de Green<a class="headerlink" href="#creation-de-lechantillonneur-de-green" title="Permanent link"></a></h1>
<p>Les dernières étapes visent à définir l'objet qui va effectuer les tirages aléatoires des boîtes qui seront créées (classe <strong>DirectSampler</strong> de librjmcmc4j) et l'échantillonneur de Green qui va définir les modifications à appliquer pendant la simulation et notamment la probabilité d'acception durant le process.</p>
<h1 id="implementation">Implémentation<a class="headerlink" href="#implementation" title="Permanent link"></a></h1>
<p>Le code ci-dessous reprend l'implémentation de la création d'un échantilloneur.</p>
<pre><code class="JAVA">
    /**
     * Creation of the sampler
     * @param rng  a random generator
     * @param p    the parameters loaded from the json file
     * @param bpU  the basic property unit on which the simulation will be proceeded
     * @param pred a predicate that will check the respect of the rules
     * @param geom a geometry that will contains all the cuboid
     * @return a sampler that will be used during the simulation process
     */
    public Sampler&lt;GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; create_sampler(RandomGenerator rng,
            SimpluParameters p, BasicPropertyUnit bpU,
            ConfigurationModificationPredicate&lt;GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; pred,
            IGeometry geom) {


        //Step 1 : Creation of the object that will control the birth and death of cuboid

        //Getting minimal and maximal dimension from the parameter file
        double minlen = Double.isNaN(this.minLengthBox) ? p.getDouble(&quot;minlen&quot;) : this.minLengthBox;
        double maxlen = Double.isNaN(this.maxLengthBox) ? p.getDouble(&quot;maxlen&quot;) : this.maxLengthBox;

        double minwid = Double.isNaN(this.minWidthBox) ? p.getDouble(&quot;minwid&quot;) : this.minWidthBox;
        double maxwid = Double.isNaN(this.maxWidthBox) ? p.getDouble(&quot;maxwid&quot;) : this.maxWidthBox;

        double minheight = p.getDouble(&quot;minheight&quot;);
        double maxheight = p.getDouble(&quot;maxheight&quot;);


        //Builder class of the object
        ObjectBuilder&lt;Cuboid&gt; builder = new CuboidBuilder();

        //The geometry in which the sampler will be instanciated
        if (geom != null) {
            samplingSurface = geom;
        }

        if (samplingSurface == null) {
            samplingSurface = bpU.getGeom();
        }
        IEnvelope env = samplingSurface.getEnvelope();

        //Instanciation of the object dedicated for the creation of new cuboid during the process
        //Passing the building, the class (TransformToSurface) that will make
        // the transformation between random numbers and coordinates inside the samplingSurface
        UniformBirth&lt;Cuboid&gt; birth = new UniformBirth&lt;Cuboid&gt;(rng,
                new Cuboid(env.minX(), env.minY(), minlen, minwid, minheight, 0),
                new Cuboid(env.maxX(), env.maxY(), maxlen, maxwid, maxheight, Math.PI), builder,
                TransformToSurface.class, samplingSurface);



        //Step 2  : Listing the modification kernel

        //List of kernel for modification during the process
        List&lt;Kernel&lt;GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt;&gt; kernels = new ArrayList&lt;&gt;();

        //A factory to create proper kernels
        KernelFactory&lt;Cuboid, GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; factory = new KernelFactory&lt;&gt;();

        //Adding the birth/death kernel
        kernels.add(
                factory.make_uniform_birth_death_kernel(rng, builder, birth, p.getDouble(&quot;pbirth&quot;), 1.0, &quot;BirthDeath&quot;));
        //Adding the other modification kernel
        double amplitudeMove = p.getDouble(&quot;amplitudeMove&quot;);
        kernels.add(factory.make_uniform_modification_kernel(rng, builder, new MoveCuboid(amplitudeMove), 0.2, &quot;Move&quot;));
        double amplitudeRotate = p.getDouble(&quot;amplitudeRotate&quot;) * Math.PI / 180;
        kernels.add(factory.make_uniform_modification_kernel(rng, builder, new RotateCuboid(amplitudeRotate), 0.2,
                &quot;Rotate&quot;));
        double amplitudeMaxDim = p.getDouble(&quot;amplitudeMaxDim&quot;);
        kernels.add(factory.make_uniform_modification_kernel(rng, builder, new ChangeWidth(amplitudeMaxDim), 0.2,
                &quot;ChgWidth&quot;));
        kernels.add(factory.make_uniform_modification_kernel(rng, builder, new ChangeLength(amplitudeMaxDim), 0.2,
                &quot;ChgLength&quot;));
        double amplitudeHeight = p.getDouble(&quot;amplitudeHeight&quot;);
        kernels.add(factory.make_uniform_modification_kernel(rng, builder, new ChangeHeight(amplitudeHeight), 0.2,
                &quot;ChgHeight&quot;));

        //Step 3  : Creation of the sampler for the brith/death of cuboid

        // This distribution create a biais to make the system tends around a certain number of boxes
        PoissonDistribution distribution = new PoissonDistribution(rng, p.getDouble(&quot;poisson&quot;));
        //Creation of the sampler with the modification in itself
        DirectSampler&lt;Cuboid, GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; ds = new DirectRejectionSampler&lt;&gt;(
                distribution, birth, pred);

        //Step 4  : Creation of the GreenSampler that will be used during the optimization process
        //It notably control the acception ratio and that the created objects and that the proposed configurations area generated
        //According to the uniformbirth
        Sampler&lt;GraphConfiguration&lt;Cuboid&gt;, BirthDeathModification&lt;Cuboid&gt;&gt; s = new GreenSamplerBlockTemperature&lt;&gt;(rng,
                ds, new MetropolisAcceptance&lt;SimpleTemperature&gt;(), kernels);
        return s;
    }
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../custom-optimisation/" class="btn btn-neutral float-right" title="Custom optimisation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../envgeo/modelgeo/" class="btn btn-neutral" title="Modelgeo"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>IGNF 2018-2019</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/SimPLU3D/simplu3D-tutorial" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../envgeo/modelgeo/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../custom-optimisation/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
